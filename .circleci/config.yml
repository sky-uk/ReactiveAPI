version: 2.1
aliases:
  - &xcode_version
      xcode: 12.0.0
  - &boot_simulator
      name: Boot Simulator
      command: xcrun instruments -w "iPhone 11 (14.0) [" || true
  - &ssh_fix
      name: SSH FIX -> https://support.circleci.com/hc/en-us/articles/360044709573-Swift-Package-Manager-fails-to-clone-from-private-Git-repositories
      command: |
        rm ~/.ssh/id_rsa
        for ip in $(dig @8.8.8.8 github.com +short); do ssh-keyscan github.com,$ip; ssh-keyscan $ip; done 2>/dev/null >> ~/.ssh/known_hosts || true
  - &restore_spm_cache
      name: Restore Swift Package Manager Cache
      key: spm-cache-{{ checksum "Package.resolved" }}
  - &save_spm_cache
      name: Save Swift Package Manager Cache
      key: spm-cache-{{ checksum "Package.resolved" }}
      paths:
        - SourcePackages
  - &unittest
      name: Run ReactiveAPI Unit Tests
      command: xcodebuild test -scheme ReactiveAPI-Package -destination 'platform=iOS Simulator,name=iPhone 11' | xcpretty
jobs:
  build-and-test:
    macos: *xcode_version
    shell: /bin/bash --login -eo pipefail
    steps:
      - checkout
      - run: *boot_simulator
      - run: *ssh_fix
      - restore_cache: *restore_spm_cache
      - run: *unittest
      - save_cache: *save_spm_cache

workflows:
  version: 2
  build-test:
    jobs:
      - build-and-test